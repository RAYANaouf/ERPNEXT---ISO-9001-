[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Evaluation Periode Essai employe",
  "enabled": 1,
  "modified": "2026-01-13 16:10:42.619873",
  "module": "ISO 9001",
  "name": "Evaluation Periode Essai",
  "script": "let decision_lock = false;\r\n\r\nfrappe.ui.form.on('Evaluation Periode Essai employe', {\r\n\r\n    // ==============================\r\n    // AUTO-REMPLISSAGE DES CRITÈRES\r\n    // ==============================\r\n    onload(frm) {\r\n        if (!frm.is_new()) return;\r\n\r\n        frm.clear_table('evaluation_details');\r\n\r\n        const criteres = [\r\n            \"حجم العمل | Volume de travail\",\r\n            \"نوعية العمل | Qualité du travail\",\r\n            \"تنفيذ المهام المرتبطة بالمنصب | Application des tâches liées au poste\",\r\n            \"الاجتهاد والتفاني في العمل | Abnégation et dévouement au travail\",\r\n            \"المحافظة على وسائل العمل | Entretien et soin des moyens de travail\",\r\n            \"احترام تعليمات المسؤول المباشر | Respect des consignes de la hiérarchie\",\r\n            \"القدرة على أداء مهام متعددة | Polyvalence\",\r\n            \"المواظبة والانضباط العام | Assiduité et discipline générale\",\r\n            \"روح الفريق | Esprit d’équipe\",\r\n            \"روح المبادرة | Esprit d’initiative\",\r\n            \"القدرة البدنية والتحمل | Robustesse\",\r\n            \"استخدام الأدوات المعلوماتية | Outil informatique\",\r\n            \"الجاهزية والتوفر | Disponibilité\"\r\n        ];\r\n\r\n        criteres.forEach(c => {\r\n            let row = frm.add_child('evaluation_details');\r\n            row.criteria = c;\r\n        });\r\n\r\n        frm.refresh_field('evaluation_details');\r\n    },\r\n\r\n    // ==============================\r\n    // BLOQUER AJOUT / SUPPRESSION\r\n    // ==============================\r\n    refresh(frm) {\r\n        if (frm.fields_dict.evaluation_details) {\r\n            const grid = frm.fields_dict.evaluation_details.grid;\r\n            grid.cannot_add_rows = true;\r\n            grid.cannot_delete_rows = true;\r\n            grid.toggle_enable('criteria', false);\r\n        }\r\n    },\r\n\r\n    // ==============================\r\n    // DÉCISION FINALE (SANS BOUCLE)\r\n    // ==============================\r\n    decision_success(frm) {\r\n        handle_decision(frm, 'decision_success');\r\n    },\r\n    decision_failed(frm) {\r\n        handle_decision(frm, 'decision_failed');\r\n    },\r\n    decision_extend(frm) {\r\n        handle_decision(frm, 'decision_extend');\r\n    }\r\n});\r\n\r\n// ==========================================\r\n// CHILD DOCTYPE : Evaluation Periode Essai Detail\r\n// ==========================================\r\nfrappe.ui.form.on('Evaluation Periode Essai Detail', {\r\n\r\n    score_1(frm, cdt, cdn) { set_score(frm, cdt, cdn, 1); },\r\n    score_2(frm, cdt, cdn) { set_score(frm, cdt, cdn, 2); },\r\n    score_3(frm, cdt, cdn) { set_score(frm, cdt, cdn, 3); },\r\n    score_4(frm, cdt, cdn) { set_score(frm, cdt, cdn, 4); },\r\n    score_5(frm, cdt, cdn) { set_score(frm, cdt, cdn, 5); }\r\n\r\n});\r\n\r\n// ==============================\r\n// FONCTION : SET SCORE\r\n// ==============================\r\nfunction set_score(frm, cdt, cdn, value) {\r\n    let row = locals[cdt][cdn];\r\n\r\n    for (let i = 1; i <= 5; i++) row[`score_${i}`] = 0;\r\n\r\n    row[`score_${value}`] = 1;\r\n    row.final_score = value;\r\n\r\n    frm.refresh_field('evaluation_details');\r\n    calculate_average(frm);\r\n}\r\n\r\n// ==============================\r\n// FONCTION : CALCUL MOYENNE\r\n// ==============================\r\nfunction calculate_average(frm) {\r\n    let total = 0;\r\n    let count = 0;\r\n\r\n    (frm.doc.evaluation_details || []).forEach(r => {\r\n        if (r.final_score) {\r\n            total += r.final_score;\r\n            count++;\r\n        }\r\n    });\r\n\r\n    frm.set_value('average_score', count ? (total / count).toFixed(2) : 0);\r\n}\r\n\r\n// ==============================\r\n// FONCTION : DÉCISION UNIQUE (SAFE)\r\n// ==============================\r\nfunction handle_decision(frm, selected) {\r\n    if (decision_lock) return;\r\n    decision_lock = true;\r\n\r\n    ['decision_success', 'decision_failed', 'decision_extend'].forEach(f => {\r\n        frm.doc[f] = (f === selected) ? 1 : 0;\r\n    });\r\n\r\n    frm.refresh_fields([\r\n        'decision_success',\r\n        'decision_failed',\r\n        'decision_extend'\r\n    ]);\r\n\r\n    decision_lock = false;\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier Evaluation",
  "enabled": 1,
  "modified": "2025-12-29 11:29:23.451177",
  "module": "ISO 9001",
  "name": "supplier evaluation",
  "script": "frappe.ui.form.on('Supplier Evaluation', {\r\n    onload_post_render: function(frm) {\r\n        // Charger automatiquement les critères si le tableau est vide\r\n        if (!frm.doc.criteria_table || frm.doc.criteria_table.length === 0 || \r\n            (frm.doc.criteria_table.length === 1 && !frm.doc.criteria_table[0].criteria)) {\r\n            console.log(\"Chargement des critères par défaut...\");\r\n            load_default_criteria(frm);\r\n        }\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        // Colorer le classement si total_score existe\r\n        if (frm.doc.total_score) {\r\n            set_color_indicator(frm);\r\n        }\r\n    },\r\n\r\n    before_save: function(frm) {\r\n        // Vérifier que la somme des pondérations = 100\r\n        let total_weighting = 0;\r\n        if (frm.doc.criteria_table) {\r\n            frm.doc.criteria_table.forEach(row => {\r\n                if (row.weighting) total_weighting += parseFloat(row.weighting);\r\n            });\r\n        }\r\n       \r\n        // Forcer le chargement des critères si vide\r\n        if (!frm.doc.criteria_table || frm.doc.criteria_table.length === 0) {\r\n            load_default_criteria(frm);\r\n        }\r\n    }\r\n});\r\n\r\n// Gestion des champs du child table\r\nfrappe.ui.form.on('Supplier Evaluation Criteria', {\r\n    weighting: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n\r\n        // Forcer pondération entre 0 et 100\r\n        if (row.weighting < 0) row.weighting = 0;\r\n        if (row.weighting > 100) row.weighting = 100;\r\n        frappe.model.set_value(cdt, cdn, 'weighting', row.weighting);\r\n\r\n        // Calculer la somme totale des pondérations\r\n        let total_weighting = 0;\r\n        if (frm.doc.criteria_table) {\r\n            frm.doc.criteria_table.forEach(r => {\r\n                if (r.weighting) total_weighting += parseFloat(r.weighting);\r\n            });\r\n        }\r\n\r\n        // Afficher l'alerte uniquement si dépassement\r\n        if (total_weighting > 100) {\r\n            frappe.show_alert({\r\n                message: __(\"Attention : la somme des pondérations dépasse 100 ! (Actuel: {0})\", [total_weighting]),\r\n                indicator: 'red'\r\n            });\r\n        }\r\n        \r\n        // Recalculer le score pondéré et total\r\n        calculate_weighted_score(frm, cdt, cdn);\r\n        calculate_total(frm);\r\n    },\r\n    \r\n    score: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        \r\n        // Forcer score entre 0 et 5\r\n        if (row.score < 0) row.score = 0;\r\n        if (row.score > 5) row.score = 5;\r\n        frappe.model.set_value(cdt, cdn, 'score', row.score);\r\n        \r\n        // Recalculer le score pondéré et total\r\n        calculate_weighted_score(frm, cdt, cdn);\r\n        calculate_total(frm);\r\n    }\r\n});\r\n\r\n// Calcul du score pondéré pour chaque ligne\r\nfunction calculate_weighted_score(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.score !== undefined && row.weighting !== undefined && row.score > 0 && row.weighting > 0) {\r\n        let weighted = ((row.score / 5) * row.weighting);\r\n        frappe.model.set_value(cdt, cdn, 'weighted_score', parseFloat(weighted.toFixed(2)));\r\n    } else {\r\n        frappe.model.set_value(cdt, cdn, 'weighted_score', 0);\r\n    }\r\n}\r\n\r\n// Calcul du total et détermination du classement\r\nfunction calculate_total(frm) {\r\n    let total = 0;\r\n    let total_weighting = 0;\r\n\r\n    if (frm.doc.criteria_table) {\r\n        frm.doc.criteria_table.forEach(function(row) {\r\n            if (row.weighted_score) total += parseFloat(row.weighted_score);\r\n            if (row.weighting) total_weighting += parseFloat(row.weighting);\r\n        });\r\n    }\r\n\r\n    frm.set_value('total_score', parseFloat(total.toFixed(2)));\r\n\r\n    // Déterminer le classement\r\n    if (total >= 85) {\r\n        frm.set_value('classement', 'Fournisseur excellent');\r\n        frm.set_value('decision', 'Maintenir et developper');\r\n    } else if (total >= 70) {\r\n        frm.set_value('classement', 'Fournisseur approuvé');\r\n        frm.set_value('decision', 'Suivi normal');\r\n    } else if (total >= 60) {\r\n        frm.set_value('classement', 'Sous surveillance');\r\n        frm.set_value('decision', 'Actions correctives exigées ');\r\n    } else {\r\n        frm.set_value('classement', 'Non approuvé');\r\n        frm.set_value('decision', 'Retirer de la liste ou plan ');\r\n    }\r\n\r\n    set_color_indicator(frm);\r\n}\r\n\r\n// Chargement des critères par défaut\r\nfunction load_default_criteria(frm) {\r\n    const criteria_list = [\r\n        \"Qualité du produit ou service / conformité\",\r\n        \"Respect des délais / transit\",\r\n        \"Prix et conditions commerciales\",\r\n        \"Réactivité et communication\",\r\n        \"Fiabilité documentaire (douane, BL, certificats)\"\r\n    ];\r\n\r\n    console.log(\"Ajout de \" + criteria_list.length + \" critères...\");\r\n\r\n    frm.clear_table('criteria_table');\r\n\r\n    criteria_list.forEach(function(criteria_name) {\r\n        let row = frm.add_child('criteria_table');\r\n        row.criteria = criteria_name;\r\n        row.weighting = 0;\r\n        row.score = 0;\r\n        row.weighted_score = 0;\r\n    });\r\n\r\n    frm.refresh_field('criteria_table');\r\n    console.log(\"Critères chargés ! Total: \" + frm.doc.criteria_table.length);\r\n}\r\n\r\n// Coloration du classement\r\nfunction set_color_indicator(frm) {\r\n    let score = frm.doc.total_score || 0;\r\n    let color;\r\n\r\n    if (score >= 85) color = 'green';\r\n    else if (score >= 70) color = 'blue';\r\n    else if (score >= 60) color = 'orange';\r\n    else color = 'red';\r\n\r\n    setTimeout(function() {\r\n        if (frm.fields_dict.classement) {\r\n            frm.get_field('classement').$wrapper.find('.control-value').css({\r\n                'color': color,\r\n                'font-weight': 'bold',\r\n                'font-size': '14px'\r\n            });\r\n        }\r\n\r\n        if (frm.fields_dict.total_score) {\r\n            frm.get_field('total_score').$wrapper.find('.control-value').css({\r\n                'color': color,\r\n                'font-weight': 'bold',\r\n                'font-size': '16px'\r\n            });\r\n        }\r\n    }, 100);\r\n}",
  "view": "Form"
 }
]